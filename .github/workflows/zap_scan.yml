name: OWASP ZAP Scan

on:
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    env:
      ZAP_TIMESTAMP: ${{ github.run_id }}  # ensures unique report name

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create report directory
        run: mkdir -p zap_reports

      - name: Run OWASP ZAP Baseline Scan in Docker
        run: |
          docker run --rm \
            -u root \
            -v ${{ github.workspace }}/zap_reports:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://testphp.vulnweb.com \
            -a \
            -J zap_report_${ZAP_TIMESTAMP}.json \
            -w zap_report_${ZAP_TIMESTAMP}.md \
            -r zap_report_${ZAP_TIMESTAMP}.html \
            || true  # allow non-zero exit so job doesn't fail on warnings

      - name: Upload ZAP HTML Report
        uses: actions/upload-artifact@v3
        with:
          name: ZAP-HTML-Report
          path: zap_reports/zap_report_${{ env.ZAP_TIMESTAMP }}.html

      - name: Upload ZAP JSON Report
        uses: actions/upload-artifact@v3
        with:
          name: ZAP-JSON-Report
          path: zap_reports/zap_report_${{ env.ZAP_TIMESTAMP }}.json

      - name: Upload ZAP Markdown Report
        uses: actions/upload-artifact@v3
        with:
          name: ZAP-MD-Report
          path: zap_reports/zap_report_${{ env.ZAP_TIMESTAMP }}.md